<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controlador de Porta de Acesso</title>
    <style>
        :root {
            --bg-body: #f5f5f5;
            --bg-container: white;
            --text-color: #333;
            --panel-bg: white;
            --input-bg: white;
            --input-border: #ddd;
            --stat-bg: #e3f2fd;
            --log-bg: #000;
            --log-text: #00ff00;
        }

        body.dark-theme {
            --bg-body: #121212;
            --bg-container: #1e1e1e;
            --text-color: #e0e0e0;
            --panel-bg: #2d2d2d;
            --input-bg: #333;
            --input-border: #555;
            --stat-bg: #263238;
            --log-bg: #000;
            --log-text: #00ff00;
        }

        body { font-family: Arial, sans-serif; margin: 20px; background: var(--bg-body); color: var(--text-color); transition: background 0.3s, color 0.3s; }
        .container { max-width: 1400px; margin: 0 auto; background: var(--bg-container); padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .stats { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .stat-card { flex: 1; padding: 15px; background: var(--stat-bg); border-radius: 6px; text-align: center; min-width: 150px; }
        .panel { margin-bottom: 20px; padding: 15px; border: 1px solid var(--input-border); border-radius: 6px; background: var(--panel-bg); }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, textarea, button, select { width: 100%; padding: 8px; border: 1px solid var(--input-border); border-radius: 4px; box-sizing: border-box; background: var(--input-bg); color: var(--text-color); }
        button { background: #2196F3; color: white; border: none; cursor: pointer; padding: 10px; }
        button:hover { opacity: 0.9; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .btn-success { background: #28a745; }
        .btn-danger { background: #dc3545; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-info { background: #17a2b8; }
        .logs { height: 500px; overflow-y: auto; background: var(--log-bg); color: var(--log-text); padding: 15px; border-radius: 4px; font-family: monospace; font-size: 12px; }
        .half { display: flex; gap: 20px; }
        .half > div { flex: 1; }
        .status { padding: 10px; border-radius: 4px; margin-bottom: 10px; text-align: center; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
        .comando-rapido { background: var(--stat-bg); padding: 10px; border-radius: 4px; margin-bottom: 10px; }
        .comando-rapido button { width: auto; margin: 2px; }
        .credenciais { display: flex; gap: 10px; }
        .credenciais .form-group { flex: 1; }
        .disparo-continuo { background: var(--stat-bg); padding: 15px; border-radius: 6px; margin-bottom: 15px; border: 2px solid #ffc107; }
        .acoes-log { display: flex; gap: 10px; margin-top: 10px; }
        .acoes-log button { width: auto; flex: 1; }
        .contador-ativo { background: #d4edda !important; animation: pulse 2s infinite; }
        body.dark-theme .contador-ativo { background: #1b5e20 !important; }
        .metodo-body { display: flex; gap: 10px; }
        .metodo-body .form-group { flex: 1; }
        .body-group { display: none; }
        
        /* Modal Config */
        .config-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .config-modal { background: var(--bg-container); padding: 20px; border-radius: 8px; width: 400px; max-width: 90%; }
        .header-actions { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .theme-switch { cursor: pointer; font-size: 24px; background: none; border: none; padding: 0; width: auto; color: var(--text-color); }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
    </style>
</head>
<body onload="initTheme()">
    <div class="container">
        <div class="header-actions">
            <h1>üö™ Controlador de Porta de Acesso</h1>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button onclick="toggleConfig()" class="btn-info" style="width: auto;">‚öôÔ∏è Config</button>
                <button onclick="toggleTheme()" class="theme-switch" id="themeBtn" title="Alternar Tema">üåô</button>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <h3>Eventos Recebidos</h3>
                <span id="eventosCount" th:text="${eventosRecebidos}" style="font-size: 24px; font-weight: bold;">0</span>
            </div>
            <div class="stat-card">
                <h3>Comandos Enviados</h3>
                <span id="disparosCount" th:text="${disparosRealizados}" style="font-size: 24px; font-weight: bold;">0</span>
            </div>
            <div class="stat-card" id="contadorContinuo" th:classappend="${disparoContinuo} ? 'contador-ativo' : ''">
                <h3>Disparos Cont√≠nuos</h3>
                <span id="contadorContinuoCount" th:text="${contadorDisparoContinuo}" style="font-size: 24px; font-weight: bold;">0</span>
            </div>
        </div>

        <div class="half">
            <div>
                <div class="panel">
                    <h2>üéØ Comando √önico</h2>
                    <div id="statusMessage"></div>
                    
                    <div class="comando-rapido">
                        <strong>Comandos R√°pidos:</strong><br>
                        <button onclick="preencherComandoGET('action=openDoor&channel=1&UserID=10&Type=Remote&Time=1')" class="btn-info">GET: Abrir Porta 1</button>
                        <button onclick="preencherComandoGET('action=openDoor&channel=2&UserID=10&Type=Remote&Time=1')" class="btn-info">GET: Abrir Porta 2</button>
                        <button onclick="preencherComandoPOST('action=setConfig', { param: 'value' })" class="btn-warning">POST: Set Config</button>
                    </div>
                    
                    <form id="comandoForm">
                        <div class="form-group">
                            <label for="ipDispositivo">IP do Dispositivo:</label>
                            <input type="text" id="ipDispositivo" name="ipDispositivo" value="10.1.17.99" required>
                        </div>
                        
                        <div class="credenciais">
                            <div class="form-group">
                                <label for="usuario">Usu√°rio:</label>
                                <input type="text" id="usuario" name="usuario" value="admin" required>
                            </div>
                            <div class="form-group">
                                <label for="senha">Senha:</label>
                                <input type="password" id="senha" name="senha" value="admin" required>
                            </div>
                        </div>
                        
                        <div class="metodo-body">
                            <div class="form-group">
                                <label for="metodo">M√©todo HTTP:</label>
                                <select id="metodo" name="metodo" required onchange="toggleBodyField()">
                                    <option value="GET" selected>GET</option>
                                    <option value="POST">POST</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="intervalo">Intervalo (ms):</label>
                                <input type="number" id="intervalo" name="intervalo" value="1000" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="comando">Comando CGI (query string):</label>
                            <textarea id="comando" name="comando" rows="2" required>action=openDoor&channel=1&UserID=10&Type=Remote&Time=1</textarea>
                        </div>
                        
                        <div class="form-group body-group" id="bodyGroup">
                            <label for="body">Body (apenas para POST):</label>
                            <textarea id="body" name="body" rows="3" placeholder='{"param": "value"}'></textarea>
                        </div>
                        
                        <button type="submit" id="submitBtn" class="btn-success">‚ñ∂Ô∏è Executar Comando √önico</button>
                    </form>
                </div>

                <div class="disparo-continuo">
                    <h2>üîÑ Disparo Cont√≠nuo</h2>
                    <form id="disparoContinuoForm">
                        <div class="form-group">
                            <label for="repeticoes">N√∫mero de Repeti√ß√µes:</label>
                            <input type="number" id="repeticoes" name="repeticoes" value="10" min="1" max="1000" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="intervaloContinuo">Intervalo entre disparos (ms):</label>
                            <input type="number" id="intervaloContinuo" name="intervaloContinuo" value="2000" min="100" max="60000" required>
                        </div>
                        
                        <button type="button" id="iniciarDisparoBtn" class="btn-warning">üöÄ Iniciar Disparo Cont√≠nuo</button>
                        <button type="button" id="pararDisparoBtn" class="btn-danger" disabled>‚èπÔ∏è Parar Disparo</button>
                    </form>
                </div>
            </div>
            
            <div>
                <div class="panel">
                    <h2>üìã Log de Atividades</h2>
                    <div class="logs" id="logArea">
                        <div th:each="mensagem : ${mensagens}" th:text="${mensagem}">Aguardando eventos...</div>
                    </div>
                    
                    <div class="acoes-log">
                        <button onclick="salvarLog()" class="btn-success">üíæ Salvar Log em TXT</button>
                        <button onclick="limparLogs()" class="btn-warning">üóëÔ∏è Limpar Logs</button>
                        <button onclick="limparTudo()" class="btn-danger">üßπ Limpar Tudo</button>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </div>

    <!-- Config Modal -->
    <div id="configOverlay" class="config-overlay" onclick="fecharConfigSeClicarFora(event)">
        <div class="config-modal">
            <h2>‚öôÔ∏è Configura√ß√µes</h2>
            <div id="configStatus"></div>
            
            <div class="form-group">
                <label for="serverPort">Porta do Servidor (Requer Rein√≠cio):</label>
                <input type="number" id="serverPort" th:value="${serverPort}" min="1024" max="65535">
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="toggleConfig()" class="btn-danger" style="width: auto;">Fechar</button>
                <button onclick="salvarPorta()" class="btn-success" style="width: auto;">üíæ Salvar</button>
            </div>
        </div>
    </div>

    <script>
        function toggleBodyField() {
            const metodo = document.getElementById('metodo').value;
            const bodyGroup = document.getElementById('bodyGroup');
            if (metodo === 'POST') {
                bodyGroup.style.display = 'block';
            } else {
                bodyGroup.style.display = 'none';
            }
        }

        function preencherComandoGET(comando) {
            document.getElementById('comando').value = comando;
            document.getElementById('metodo').value = 'GET';
            document.getElementById('body').value = '';
            toggleBodyField();
        }

        function preencherComandoPOST(comando, body) {
            document.getElementById('comando').value = comando;
            document.getElementById('metodo').value = 'POST';
            document.getElementById('body').value = body || '';
            toggleBodyField();
        }

        function mostrarStatus(mensagem, tipo) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="status ${tipo}">${mensagem}</div>`;
            setTimeout(() => statusDiv.innerHTML = '', 5000);
        }

        function atualizarPagina() {
            fetch(window.location.href)
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    document.getElementById('eventosCount').textContent = 
                        doc.getElementById('eventosCount').textContent;
                    document.getElementById('disparosCount').textContent = 
                        doc.getElementById('disparosCount').textContent;
                    document.getElementById('contadorContinuoCount').textContent = 
                        doc.getElementById('contadorContinuoCount').textContent;
                    
                    // Atualiza estado do disparo cont√≠nuo
                    const contadorElem = document.getElementById('contadorContinuo');
                    const isActive = doc.getElementById('contadorContinuo').className.includes('contador-ativo');
                    if (isActive) {
                        contadorElem.classList.add('contador-ativo');
                        document.getElementById('pararDisparoBtn').disabled = false;
                        document.getElementById('iniciarDisparoBtn').disabled = true;
                    } else {
                        contadorElem.classList.remove('contador-ativo');
                        document.getElementById('pararDisparoBtn').disabled = true;
                        document.getElementById('iniciarDisparoBtn').disabled = false;
                    }
                    
                    document.getElementById('logArea').innerHTML = 
                        doc.getElementById('logArea').innerHTML;
                    
                    rolarLogsParaBaixo();
                });
        }

        setInterval(atualizarPagina, 1000);

        // Comando √∫nico
        document.getElementById('comandoForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = '‚è≥ Enviando...';
            
            try {
                const formData = new FormData(this);
                const response = await fetch('/disparar', {
                    method: 'POST',
                    body: new URLSearchParams(formData)
                });
                
                const result = await response.text();
                mostrarStatus(result, response.ok ? 'success' : 'error');
                setTimeout(atualizarPagina, 500);
                
            } catch (error) {
                mostrarStatus('Erro: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '‚ñ∂Ô∏è Executar Comando √önico';
            }
        });

        // Disparo cont√≠nuo
        document.getElementById('iniciarDisparoBtn').addEventListener('click', async function() {
            const formData = new FormData(document.getElementById('comandoForm'));
            formData.append('repeticoes', document.getElementById('repeticoes').value);
            formData.append('intervalo', document.getElementById('intervaloContinuo').value);
            
            try {
                const response = await fetch('/disparo-continuo/iniciar', {
                    method: 'POST',
                    body: new URLSearchParams(formData)
                });
                
                const result = await response.text();
                mostrarStatus(result, response.ok ? 'success' : 'error');
                atualizarPagina();
                
            } catch (error) {
                mostrarStatus('Erro: ' + error.message, 'error');
            }
        });

        document.getElementById('pararDisparoBtn').addEventListener('click', async function() {
            try {
                const response = await fetch('/disparo-continuo/parar', { method: 'POST' });
                const result = await response.text();
                mostrarStatus(result, response.ok ? 'success' : 'error');
                atualizarPagina();
            } catch (error) {
                mostrarStatus('Erro: ' + error.message, 'error');
            }
        });

        async function salvarLog() {
            try {
                const response = await fetch('/salvar-log', { method: 'POST' });
                const result = await response.text();
                mostrarStatus(result, response.ok ? 'success' : 'error');
                atualizarPagina();
            } catch (error) {
                mostrarStatus('Erro ao salvar: ' + error.message, 'error');
            }
        }

        async function limparLogs() {
            try {
                const response = await fetch('/limpar-logs', { method: 'POST' });
                const result = await response.text();
                mostrarStatus(result, 'success');
                setTimeout(atualizarPagina, 500);
            } catch (error) {
                mostrarStatus('Erro: ' + error.message, 'error');
            }
        }

        async function limparTudo() {
            if (confirm('Tem certeza que deseja limpar TODOS os dados? Isso resetar√° os contadores e logs.')) {
                try {
                    const response = await fetch('/limpar-tudo', { method: 'POST' });
                    const result = await response.text();
                    mostrarStatus(result, 'success');
                    setTimeout(atualizarPagina, 500);
                } catch (error) {
                    mostrarStatus('Erro: ' + error.message, 'error');
                }
            }
        }

        function rolarLogsParaBaixo() {
            const logArea = document.getElementById('logArea');
            logArea.scrollTop = logArea.scrollHeight;
        }

        // Rolagem autom√°tica
        new MutationObserver(rolarLogsParaBaixo)
            .observe(document.getElementById('logArea'), { childList: true });

        async function salvarPorta() {
            const port = document.getElementById('serverPort').value;
            const statusDiv = document.getElementById('configStatus');
            
            try {
                const response = await fetch('/config/port', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: 'newPort=' + port
                });
                
                const result = await response.text();
                
                statusDiv.innerHTML = `<div class="status ${response.ok ? 'success' : 'error'}">${result}</div>`;
                
                if (response.ok) {
                    mostrarStatus(result, 'warning'); // Mostra na tela principal tamb√©m
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">Erro: ${error.message}</div>`;
            }
        }

        function toggleConfig() {
            const overlay = document.getElementById('configOverlay');
            overlay.style.display = overlay.style.display === 'flex' ? 'none' : 'flex';
        }

        function fecharConfigSeClicarFora(e) {
            if (e.target.id === 'configOverlay') {
                toggleConfig();
            }
        }

        // Theme management
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const themeBtn = document.getElementById('themeBtn');
            
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
                themeBtn.textContent = '‚òÄÔ∏è';
            } else {
                document.body.classList.remove('dark-theme');
                themeBtn.textContent = 'üåô';
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
            const isDark = document.body.classList.contains('dark-theme');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('themeBtn').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            toggleBodyField();
            initTheme();
            const ipField = document.getElementById('ipDispositivo');
            if (ipField) {
                ipField.focus();
            }
        });
    </script>
</body>
</html>